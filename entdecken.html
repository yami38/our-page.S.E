<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let basket = { x: 0, y: 0, width: 60, height: 20 };
    let objects = [];
    let score = 0;
    let missed = 0;
    let speed = 2;
    let spawnRate = 1000;
    let lastSpawn = 0;
    let lastTime = 0;
    let bestScore = parseInt(localStorage.getItem("bestScore") || "0");

    document.getElementById("best").innerText = bestScore;

    const types = [
        { emoji: "üß°", points: 1, bad: false, chance: 0.5 },
        { emoji: "üñï", points: -1, bad: true, chance: 0.1 },
        { emoji: "‚ù§Ô∏è", points: 2, bad: false, chance: 0.25 },
        { emoji: "üíé", points: 5, bad: false, chance: 0.05 },
        { emoji: "‚≠ê", points: 3, bad: false, chance: 0.1 }
    ];

    function resizeCanvas() {
        canvas.width = Math.min(window.innerWidth - 20, 500);
        canvas.height = Math.min(window.innerHeight * 0.6, 600);
        basket.x = canvas.width / 2 - basket.width / 2;
        basket.y = canvas.height - 40;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    function drawBasket() {
        ctx.fillStyle = "pink";
        ctx.fillRect(basket.x, basket.y, basket.width, basket.height);
    }

    function spawnObject() {
        let r = Math.random();
        let cumulative = 0;
        for (let type of types) {
            cumulative += type.chance;
            if (r <= cumulative) {
                objects.push({ 
                    type: type, 
                    x: Math.random() * (canvas.width - 30), 
                    y: -30,
                    width: 30,
                    height: 30
                });
                break;
            }
        }
    }

    function drawObjects() {
        ctx.font = "28px Arial";
        ctx.textBaseline = "top";
        ctx.textAlign = "center";
        objects.forEach(o => {
            ctx.fillText(o.type.emoji, o.x + 15, o.y);
            o.y += speed;
        });
    }

    function checkCollisions() {
        objects = objects.filter(o => {
            const basketTop = basket.y;
            const basketBottom = basket.y + basket.height;
            const basketLeft = basket.x;
            const basketRight = basket.x + basket.width;
            const objBottom = o.y + o.height;
            const objLeft = o.x;
            const objRight = o.x + o.width;

            // Treffer
            if (objBottom > basketTop && o.y < basketBottom && objRight > basketLeft && objLeft < basketRight) {
                score += o.type.points;
                document.getElementById("score").innerText = score;

                if (score > bestScore) {
                    bestScore = score;
                    document.getElementById("best").innerText = score;
                    localStorage.setItem("bestScore", score);
                }
                return false;
            }

            // Verpasst
            if (o.y > canvas.height) {
                if (!o.type.bad || o.type.emoji === "üñï") {
                    missed++;
                    document.getElementById("missed").innerText = missed;
                    if (missed >= 5) {
                        alert("Game Over! Dein Score: " + score);
                        resetGame();
                    }
                }
                return false;
            }
            return true;
        });
    }

    function resetGame() {
        score = 0;
        missed = 0;
        speed = 2;
        spawnRate = 1000;
        objects = [];
        document.getElementById("score").innerText = score;
        document.getElementById("missed").innerText = missed;
    }

    function gameLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBasket();
        drawObjects();
        checkCollisions();

        lastSpawn += deltaTime;
        if (lastSpawn >= spawnRate) {
            spawnObject();
            lastSpawn = 0;
        }

        if (score % 10 === 0 && score > 0) {
            speed = Math.min(5, 2 + score * 0.05);
            spawnRate = Math.max(300, 1000 - score * 10);
        }

        requestAnimationFrame(gameLoop);
    }

    document.addEventListener("keydown", e => {
        if (e.key === "ArrowRight") basket.x = Math.min(canvas.width - basket.width, basket.x + 20);
        if (e.key === "ArrowLeft") basket.x = Math.max(0, basket.x - 20);
    });

    canvas.addEventListener("touchmove", e => {
        e.preventDefault();
        let touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
        basket.x = Math.max(0, Math.min(canvas.width - basket.width, touchX - basket.width / 2));
    }, { passive: false });

    canvas.addEventListener("mousemove", e => {
        let mouseX = e.clientX - canvas.getBoundingClientRect().left;
        basket.x = Math.max(0, Math.min(canvas.width - basket.width, mouseX - basket.width / 2));
    });

    requestAnimationFrame(gameLoop);
</script>
